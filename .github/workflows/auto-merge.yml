name: Auto Merge Release PRs

on:
  workflow_run:
    workflows: ["Auto PR for Claude Branches"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    # Only run after auto-pr succeeds on a claude/release-* branch
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      startsWith(github.event.workflow_run.head_branch, 'claude/release-')

    steps:
      - name: Find and merge release PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${{ github.event.workflow_run.head_branch }}"
          echo "Looking for release PR from branch: $BRANCH"

          PR_NUMBER=$(gh pr list \
            --head "$BRANCH" \
            --base main \
            --state open \
            --json number \
            --jq '.[0].number // empty' \
            --repo "${{ github.repository }}")

          if [ -z "$PR_NUMBER" ]; then
            echo "⏭️ No open PR found for branch $BRANCH - skipping"
            exit 0
          fi

          PR_TITLE=$(gh pr view "$PR_NUMBER" --json title --jq '.title' --repo "${{ github.repository }}")
          echo "Found PR #$PR_NUMBER: $PR_TITLE"

          if ! echo "$PR_TITLE" | grep -qE "^Release v"; then
            echo "⏭️ PR #$PR_NUMBER is not a release PR - skipping"
            exit 0
          fi

          echo "✅ Merging release PR #$PR_NUMBER"
          gh pr merge "$PR_NUMBER" \
            --merge \
            --delete-branch \
            --subject "Merge release PR #${PR_NUMBER}" \
            --body "Automatically merged by GitHub Actions after all checks passed." \
            --repo "${{ github.repository }}"

          echo "✅ PR #$PR_NUMBER merged successfully"
