name: Auto Merge Release PRs

on:
  workflow_run:
    workflows: ["Auto PR for Claude Branches"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    # head_branch here is "main" (the branch auto-pr.yml itself ran on),
    # not the original claude/release-* branch — so we skip the branch check
    # and rely on the PR title guard in the step instead.
    if: github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Find and merge release PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Looking for open Release v* PR targeting main"

          PR_NUMBER=$(gh pr list \
            --base main \
            --state open \
            --json number,title \
            --jq '[.[] | select(.title | test("^Release v"))] | .[0].number // empty' \
            --repo "${{ github.repository }}")

          if [ -z "$PR_NUMBER" ]; then
            echo "⏭️ No open release PR found - skipping"
            exit 0
          fi

          PR_TITLE=$(gh pr view "$PR_NUMBER" --json title --jq '.title' --repo "${{ github.repository }}")
          echo "Found PR #$PR_NUMBER: $PR_TITLE"

          echo "✅ Merging release PR #$PR_NUMBER"
          gh pr merge "$PR_NUMBER" \
            --merge \
            --delete-branch \
            --subject "Merge release PR #${PR_NUMBER}" \
            --body "Automatically merged by GitHub Actions after all checks passed." \
            --repo "${{ github.repository }}"

          echo "✅ PR #$PR_NUMBER merged successfully"
